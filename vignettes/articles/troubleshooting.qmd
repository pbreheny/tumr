---
title: "Troubleshooting"
format: 
  html:
    toc: true
    toc-depth: 3
---

```{r}
library(tumr)
```


## Convergence Failure with lmm()

If you encounter the warning

::: {.text-center}
*"Model failed to converge with max|grad|"*
:::

when fitting a model with lmm(), one common cause is poor scaling of the time variable. A simple and effective fix is to rescale time to a larger unit (for example, from days to months).

#### Example

Using the melanoma2 dataset, the following code produces a convergence warning:

```{r}
data(melanoma2)
mel2 <- tumr(melanoma2, ID, Day, Volume, Treatment)
lmm(mel2)
```

#### Solution: Rescale the Time Variable

In this case, converting time from days to months resolves the convergence issue. Below, we create a new time variable by dividing by the average number of days per month, update the tumr object, and refit the model:

```{r}
melanoma2$months <- melanoma2$Day / (365/12)
mel2 <- tumr(melanoma2, ID, months, Volume, Treatment)
lmm(mel2)
```

After rescaling the time variable, the model fits without producing the convergence warning.

#### Why This Works

Rescaling time can improve numerical stability during optimization, making it easier for the model to converge—especially when time values are large or measured on a very fine scale.


## Putting lmm() Summary Plot on the Log Scale

When viewing the summary plot from lmm(), you may see the message:

::: {.text-center}
*“Model has log1p-transformed response. Back-transforming predictions to original response scale.Standard errors are still on the transformed scale.”*
:::

This message appears because lmm() fits the model using a log1p-transformed response by default, and the plot() method automatically back-transforms predicted values to the original response scale.

If you prefer to view the predicted volume values on the log scale, you can apply a log transformation directly to the plot’s y-axis. Since the summary plot is a ggplot2 object, this can be done using scale_y_continuous() with a log1p transformation from the scales package.

```{r}
lmm_mel2 <- lmm(mel2)
plot(lmm_mel2)$predicted_measure + ggplot2::scale_y_continuous(trans = scales::log1p_trans())
```

This approach preserves the model fit while allowing you to visualize predictions and uncertainty on the transformed scale.

## lmm() Summary with Edited Formula

The lmm() function allows you to override the default model formula, providing flexibility when fitting alternative model specifications.

By default, lmm() fits a model of the form
`log1p(measure) ~ group * time + (time | id)`
(for example, `Volume ~ months + (1 | ID)`).

In the example below, the default formula is replaced with a simpler model that uses a rescaled time variable and a random intercept only:

```{r}
lmm_mel2 <- lmm(
                 tumr_obj = mel2,
                 formula = "Volume ~ months + (1 | ID)"
               )
```

While the model fits successfully, calling summary() on this object will fail.

This occurs because the summary() method is designed around the default lmm() model structure and currently assumes that formula. As a result, alternative formulas may not be fully supported by summary().

When using a custom formula, keep in mind that some downstream methods—such as summary()—may not behave as expected.
