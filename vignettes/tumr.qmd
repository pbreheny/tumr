---
title: "Getting started with the tumr package"
vignette: >
  %\VignetteIndexEntry{Quarto HTML Vignettes}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---

In this guide, we demonstrate the core functionality of the tumr package using the melanoma2 dataset included with the package. All code required to reproduce the examples is provided below.

# Loading the Data

```{r}
library(tumr)
data("melanoma2")
```

# A Naive Mean-Based Visualization

Before introducing tumr functionality, we first construct a simple plotting function to illustrate a common pitfall in tumor growth visualization.

#### Code for plot_mean()
```{r}
#| code-fold: true
plot_mean <- function(data, group, time, measure, id, stat = median, remove_na = FALSE){
  data_summary <- data |>
    dplyr::group_by({{group}}, {{time}}) |>
    dplyr::summarise(measure = stat({{measure}}, na.rm = remove_na), .groups = "drop_last") |>
    dplyr::ungroup()

  if (remove_na == TRUE) {
    data_full <- data |>
      na.omit(data)
  } else {
    data_full <- data
  }

  ggplot2::ggplot() +
    ggplot2::geom_line(data = data_full,
                       ggplot2::aes(x = {{time}},
                                    y = {{measure}},
                                    group = {{id}},
                                    color = {{group}}),
                       alpha = 0.5)  +
    ggplot2::geom_line(data = data_summary,
                       ggplot2::aes(x = {{time}},
                                    y = measure,
                                    color = {{group}}),
                       linewidth = 1.2) +
    ggplot2::labs(
            y = "Volume",
            title = "Volume over Time"
          )

}
```

**Note:** plot_mean() is not part of the tumr package. It is defined here solely to provide a baseline visualization for comparison with tumr’s methods.

# Creating a tumr Object

Most tumr functions operate on a tumr object, which stores both the data and its associated metadata (subject ID, time, outcome, and grouping variable).

To create a tumr object, use the tumr() function:

```{r}
mel2 <- tumr(melanoma2, ID, Day, Volume, Treatment)
```

This object can now be passed directly into other tumr functions.

# Visualizing Tumor Growth

The figure below compares a naive longitudinal visualization with a tumr-based approach that explicitly accounts for censoring and missing observations.

```{r}
#| layout-ncol: 2
#| fig-width: 4
#| fig-height: 3.5
plot_mean(melanoma2, Treatment, Day, Volume, ID, stat = mean)
plot_median(mel2)
```

The plot on the left uses a straightforward summary of observed data at each time point. This approach ignores the structure of missingness common in tumor growth studies, where subjects frequently leave the study due to censoring or dropout. As a result, the apparent decline in tumor volume over time is an artifact of estimating summaries from a progressively smaller subset of subjects rather than a true biological effect.

The visualization produced by plot_median() addresses these issues through an explicit preprocessing step designed for longitudinal tumor data.

Before any summary statistic is computed, the function:

1. **Aligns time points across subjects**
Rows are added for unobserved time points so that all subjects share a common time grid.
2. **Handles trailing missing values due to censoring**
The last observed value is carried forward and marked with a "+" to indicate right-censoring.
  * Example: 3, 6, 9, NA → 3, 6, 9, 9+
3. **Interpolates embedded missing values**
Missing observations that occur between recorded time points are interpolated to preserve trajectory continuity.

After preprocessing, tumor volume summaries are computed at each time point within each treatment group using a Kaplan–Meier–based approach. This strategy ensures that summaries reflect both observed data and informative missingness, producing a visualization that more accurately represents tumor growth dynamics over time.

# Response feature analysis

One of the primary analysis tools in tumr is the rfeat() function, which implements response feature analysis. This two-stage approach simplifies complex longitudinal data by extracting a single interpretable summary measure per subject.

Specifically, rfeat():

1. Computes a growth slope (beta coefficient) for each subject
2. Averages these slopes within each treatment group
3. Compares group-level summaries using one of the following methods:

    * t-test
    * ANOVA
    * Tukey post-hoc test
    * Both ANOVA and Tukey post-hoc tests
  
The example below uses comparison = "both" to perform ANOVA followed by Tukey post-hoc comparisons.

```{r}
(rfeat_mel2 <- rfeat(mel2, comparison = "both"))
```

## Plotting Response Feature Results

The plot() method for rfeat objects displays both the individual subject slopes and the group-level means.

```{r}
plot(rfeat_mel2)
```

# Linear mixed model

The tumr package also includes lmm(), which fits a linear mixed effects model to tumor growth data. Linear mixed models are well suited for longitudinal data because they account for:

  * Fixed effects: population-level effects of interest (e.g., treatment, time)
  * Random effects: subject-specific variability that induces correlation among repeated measurements

By default, lmm() fits the model:

::: {.text-center}
`log1p(measure) ~ group * time + (time | id)`
:::

This specification allows each subject to have their own growth trajectory while estimating overall treatment effects. The model formula can be customized if desired.

```{r}
(lmm_mel2 <- lmm(mel2))
```

**Note:** You may see a convergence warning when fitting this model. If this occurs, see the [Troubleshooting](articles/troubleshooting.html) article for guidance.

## Summarizing Linear Mixed Model Results

The summary() method for lmm objects uses the emmeans package to report:

  * The overall effect of time
  * Treatment-specific slopes over time
  * Statistical tests comparing slope differences between groups

```{r}
summary(lmm_mel2)
```


## Plotting Linear Mixed Model Results

Finally, tumr provides a plot() method for lmm objects that produces two visualizations:

1. Predicted tumor growth trajectories over time
2. Estimated mean growth slopes for each group with confidence intervals

```{r}
plot(lmm_mel2, "predict")
plot(lmm_mel2, "slope")
```


# Bayesian Hierarchical Linear Model

In addition to the linear mixed model, the package also supports fitting a Bayesian hierarchical linear model.

For subject $i$ in treatment group $g$, the outcome at time $t_n$ is modeled as

$$
y_n \sim \mathcal{N}\big(\beta_{i,1} + \beta_{i,2} t_n,\ \sigma\big),
$$

where subject-specific intercepts and slopes follow a hierarchical structure:

$$
\begin{pmatrix}
\beta_{i,1} \\
\beta_{i,2}
\end{pmatrix}
=
\begin{pmatrix}
\text{Int}_g \\
\text{Slope}_g
\end{pmatrix}
+
L z_i, 
\qquad
z_i \sim \mathcal{N}(0, I).
$$

Here, $\text{Int}_g$ and $\text{Slope}_g$ denote treatment-level mean intercepts and slopes, and $L$ is the Cholesky factor of the random-effect covariance matrix. Weakly informative normal priors are assigned to treatment-level effects and variance components, with an LKJ prior on the correlation structure.

```{r}
#| eval: false
fit <- bhm(data = melanoma2, diagnostics = FALSE, return_fit = TRUE)
```


## Summary

The `summary()` method provides posterior summaries of:

- Treatment-specific intercepts with exponential transformation
- Treatment-specific slopes with exponential transformation  
- Pairwise treatment contrasts in slopes with exponential transformation

Posterior means and credible intervals are reported for all quantities.

```{r}
#| eval: false
summary(fit)
```


## Plot

The `plot()` method visualizes posterior summaries, including:

- Treatment-specific slope estimates with 90% credible intervals  
- Pairwise slope contrasts  
- Optional MCMC trace plots for model diagnostics  

```{r}
#| eval: false
plot(fit, "predict")
plot(fit, "slope")
plot(fit, "contrast")
plot(fit, "trace")
```

